<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sindbad Ship Cruises - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1e3a8a;
            --primary-dark: #1e40af;
            --secondary: #0ea5e9;
            --accent: #06b6d4;
        }
        
        body { 
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            font-family: 'Inter', sans-serif;
        }
        
        .sidebar { 
            transition: all 0.3s ease;
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
        }
        
        .card-hover { 
            transition: all 0.3s ease; 
        }
        
        .card-hover:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        }
        
        .stats-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-left: 4px solid var(--primary);
        }
        
        .nav-active {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .wave-bg {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 120' preserveAspectRatio='none'%3E%3Cpath d='M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z' fill='%231e3a8a' fill-opacity='0.1'%3E%3C/path%3E%3C/svg%3E");
            background-size: cover;
            background-position: bottom;
        }

        .chat-message {
            max-width: 80%;
            margin: 8px 0;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease-in;
        }

        .admin-message {
            background: #dcf8c6;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .user-message {
            background: #ffffff;
            border: 1px solid #e5e5e5;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            background: #f8f9fa;
        }

        .session-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .message-time {
            font-size: 0.7rem;
            color: #666;
            margin-top: 4px;
        }

        .capacity-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fef7cd 100%);
            border-left: 4px solid #d97706;
        }

        .capacity-full {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left: 4px solid #dc2626;
        }

        .sindbad-gradient {
            background: linear-gradient(135deg, #1e3a8a 0%, #0ea5e9 100%);
        }

        .ocean-wave {
            background: linear-gradient(90deg, #1e3a8a, #0ea5e9, #06b6d4, #0ea5e9, #1e3a8a);
            background-size: 400% 400%;
            animation: wave 8s ease-in-out infinite;
        }

        @keyframes wave {
            0% { background-position: 0% 50% }
            50% { background-position: 100% 50% }
            100% { background-position: 0% 50% }
        }
    </style>
</head>
<body class="font-sans antialiased">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center transition-opacity duration-300">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-900 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600 loading-pulse">Loading Sindbad Ship Cruises Dashboard...</p>
        </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-lg shadow-lg z-50 hidden">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i data-feather="alert-triangle" class="w-5 h-5 mr-3"></i>
                <div>
                    <p class="font-medium" id="errorTitle">Connection Error</p>
                    <p class="text-sm" id="errorText">Failed to load data from server</p>
                </div>
            </div>
            <button onclick="hideError()" class="ml-4 text-red-500 hover:text-red-700">
                <i data-feather="x" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-6 py-4 rounded-lg shadow-lg z-50 hidden">
        <div class="flex items-center">
            <i data-feather="check-circle" class="w-5 h-5 mr-3"></i>
            <div>
                <p class="font-medium" id="successTitle">Success</p>
                <p class="text-sm" id="successText">Operation completed successfully</p>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl h-[600px] flex flex-col">
            <div class="flex justify-between items-center p-6 border-b">
                <div>
                    <h3 class="font-bold text-lg" id="chatUserName">Customer Chat</h3>
                    <p class="text-sm text-gray-600" id="chatUserPhone">Loading...</p>
                    <div class="flex items-center space-x-2 mt-1">
                        <span class="text-xs text-gray-500">Session:</span>
                        <span id="chatSessionStatus" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Checking...</span>
                    </div>
                </div>
                <button id="closeChat" class="text-gray-500 hover:text-gray-700">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="flex-1 p-4 overflow-hidden">
                <div class="chat-container p-4" id="chatMessages">
                    <div class="text-center text-gray-500 py-8">
                        <i data-feather="message-circle" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p>Loading conversation...</p>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t">
                <div class="flex space-x-3">
                    <input type="text" id="chatMessageInput" placeholder="Type your message..." 
                           class="flex-1 px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-900">
                    <button id="sendChatMessage" class="sindbad-gradient text-white px-6 py-3 rounded-xl hover:opacity-90 transition-all">
                        <i data-feather="send" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="mt-2 flex flex-wrap gap-2">
                    <button onclick="insertQuickMessage('Hello! How can I help you with your Sindbad cruise booking?')" class="text-xs bg-gray-100 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-200">
                        Quick Help
                    </button>
                    <button onclick="insertQuickMessage('Can you please provide more details about your cruise booking?')" class="text-xs bg-gray-100 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-200">
                        More Details
                    </button>
                    <button onclick="insertQuickMessage('Our Sindbad team will contact you shortly about your cruise.')" class="text-xs bg-gray-100 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-200">
                        Team Contact
                    </button>
                    <button onclick="insertQuickMessage('Thank you for choosing Sindbad Ship Cruises! ðŸŒŠ')" class="text-xs bg-gray-100 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-200">
                        Thank You
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-64 text-white flex flex-col shadow-xl">
            <div class="p-6 flex items-center space-x-3 border-b border-white border-opacity-20">
                <div class="p-2 rounded-lg ocean-wave">
                    <i data-feather="anchor" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <span class="font-bold text-lg">Sindbad Cruises</span>
                    <p class="text-xs text-blue-200">Muscat, Oman</p>
                </div>
            </div>
            
            <nav class="flex-1 p-6 space-y-2">
                <a href="#" id="dashboardLink" class="nav-active flex items-center space-x-3 p-3 rounded-xl bg-white bg-opacity-20 shadow-lg transition-all">
                    <i data-feather="home" class="w-5 h-5"></i>
                    <span class="font-medium">Dashboard</span>
                </a>
                <a href="#" id="leadsLink" class="flex items-center space-x-3 p-3 rounded-xl hover:bg-white hover:bg-opacity-10 transition-all">
                    <i data-feather="users" class="w-5 h-5"></i>
                    <span class="font-medium">Bookings</span>
                </a>
                <a href="#" id="capacityLink" class="flex items-center space-x-3 p-3 rounded-xl hover:bg-white hover:bg-opacity-10 transition-all">
                    <i data-feather="bar-chart-2" class="w-5 h-5"></i>
                    <span class="font-medium">Capacity</span>
                </a>
                <a href="#" id="chatLink" class="flex items-center space-x-3 p-3 rounded-xl hover:bg-white hover:bg-opacity-10 transition-all">
                    <i data-feather="message-circle" class="w-5 h-5"></i>
                    <span class="font-medium">Live Chat</span>
                </a>
                <a href="#" id="broadcastLink" class="flex items-center space-x-3 p-3 rounded-xl hover:bg-white hover:bg-opacity-10 transition-all">
                    <i data-feather="send" class="w-5 h-5"></i>
                    <span class="font-medium">Broadcast</span>
                </a>
                <a href="#" id="reportsLink" class="flex items-center space-x-3 p-3 rounded-xl hover:bg-white hover:bg-opacity-10 transition-all">
                    <i data-feather="file-text" class="w-5 h-5"></i>
                    <span class="font-medium">Reports</span>
                </a>
            </nav>
            
            <div class="p-6 border-t border-white border-opacity-20">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <i data-feather="user" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium">Admin User</p>
                        <p class="text-xs text-blue-200" id="connectionStatus">Connected</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto bg-gray-50">
            <header class="bg-white shadow-sm p-6 flex justify-between items-center border-b wave-bg">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">Dashboard Overview</h1>
                    <p class="text-gray-600" id="pageSubtitle">Sindbad Ship Cruises - Luxury Sea Experiences</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <i data-feather="clock" class="w-4 h-4"></i>
                        <span id="currentTime">--:--:--</span>
                    </div>
                    <button id="refreshBtn" class="flex items-center space-x-2 sindbad-gradient text-white px-4 py-2 rounded-xl hover:opacity-90 transition-all shadow-lg">
                        <i data-feather="refresh-cw" class="w-4 h-4"></i>
                        <span>Refresh Data</span>
                    </button>
                </div>
            </header>

            <!-- Content Sections -->
            <div class="p-6 space-y-6" id="content">
                <!-- Dashboard Overview -->
                <div id="dashboardSection">
                    <!-- Analytics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="stats-card rounded-2xl shadow-lg p-6 card-hover">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">Total Bookings</p>
                                    <h3 class="text-3xl font-bold text-gray-800 mt-2" id="totalBookings">0</h3>
                                    <p class="text-green-600 text-sm mt-1" id="bookingsGrowth">+0 today</p>
                                </div>
                                <div class="p-3 rounded-xl bg-blue-100">
                                    <i data-feather="users" class="w-6 h-6 text-blue-900"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-card rounded-2xl shadow-lg p-6 card-hover">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">Confirmed</p>
                                    <h3 class="text-3xl font-bold text-gray-800 mt-2" id="confirmedBookings">0</h3>
                                    <p class="text-green-600 text-sm mt-1" id="confirmedPercentage">0%</p>
                                </div>
                                <div class="p-3 rounded-xl bg-green-100">
                                    <i data-feather="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-card rounded-2xl shadow-lg p-6 card-hover">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">Total Revenue</p>
                                    <h3 class="text-3xl font-bold text-gray-800 mt-2" id="totalRevenue">0 OMR</h3>
                                    <p class="text-blue-600 text-sm mt-1" id="revenueGrowth">+0 today</p>
                                </div>
                                <div class="p-3 rounded-xl bg-purple-100">
                                    <i data-feather="dollar-sign" class="w-6 h-6 text-purple-600"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-card rounded-2xl shadow-lg p-6 card-hover">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">Active Chats</p>
                                    <h3 class="text-3xl font-bold text-gray-800 mt-2" id="activeSessions">0</h3>
                                    <p class="text-blue-600 text-sm mt-1" id="sessionsGrowth">+0 active</p>
                                </div>
                                <div class="p-3 rounded-xl bg-orange-100">
                                    <i data-feather="message-circle" class="w-6 h-6 text-orange-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="font-bold text-lg mb-4">Cruise Type Distribution</h3>
                            <div class="h-64 flex items-center justify-center" id="cruiseChartContainer">
                                <canvas id="cruiseChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="font-bold text-lg mb-4">Booking Status</h3>
                            <div class="h-64 flex items-center justify-center" id="statusChartContainer">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Bookings -->
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-lg">Recent Bookings</h3>
                            <button onclick="showSection('leads')" class="text-blue-900 hover:text-blue-700 text-sm font-medium">View All Bookings</button>
                        </div>
                        <div class="space-y-4" id="recentBookings">
                            <div class="text-center py-8 text-gray-500">
                                <i data-feather="users" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                <p>No bookings data available</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bookings Management -->
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden" id="leadsSection" style="display:none;">
                    <div class="p-6 flex justify-between items-center border-b">
                        <div>
                            <h3 class="font-bold text-lg">Bookings Management</h3>
                            <p class="text-gray-600 text-sm">Manage and track all Sindbad cruise bookings</p>
                        </div>
                        <div class="flex space-x-3">
                            <div class="relative">
                                <input type="text" id="searchBookings" placeholder="Search bookings..." class="pl-10 pr-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-900">
                                <i data-feather="search" class="w-4 h-4 absolute left-3 top-3 text-gray-400"></i>
                            </div>
                            <button id="exportPDF" class="flex items-center space-x-2 bg-blue-100 text-blue-700 px-4 py-2 rounded-xl hover:bg-blue-200 transition-all">
                                <i data-feather="download" class="w-4 h-4"></i>
                                <span>Export CSV</span>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" id="bookingsTable">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Booking ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cruise Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guests</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="bookingsTableBody">
                                <tr>
                                    <td colspan="10" class="px-6 py-4 text-center text-gray-500">
                                        <div class="flex items-center justify-center space-x-2">
                                            <div class="w-4 h-4 border-2 border-blue-900 border-t-transparent rounded-full animate-spin"></div>
                                            <span>Loading bookings from Google Sheets...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t flex justify-between items-center bg-gray-50">
                        <div class="text-sm text-gray-600" id="bookingsPaginationInfo">Showing 0 of 0 bookings</div>
                        <div class="flex space-x-2" id="bookingsPagination"></div>
                    </div>
                </div>

                <!-- Capacity Monitor -->
                <div class="bg-white rounded-2xl shadow-lg p-6" id="capacitySection" style="display:none;">
                    <h3 class="font-bold text-lg mb-2">Capacity Monitor</h3>
                    <p class="text-gray-600 mb-6">Real-time cruise capacity tracking (Max: 135 guests per cruise)</p>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 mb-2 font-medium">Select Date</label>
                        <input type="date" id="capacityDate" class="px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-900" onchange="updateCapacityDisplay()">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="capacityCards">
                        <!-- Capacity cards will be dynamically generated -->
                    </div>

                    <!-- Capacity Trends -->
                    <div class="mt-8 bg-gray-50 rounded-xl p-6">
                        <h4 class="font-bold mb-4">Capacity Trends</h4>
                        <div class="h-64">
                            <canvas id="capacityChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Live Chat Section -->
                <div class="bg-white rounded-2xl shadow-lg p-6" id="chatSection" style="display:none;">
                    <h3 class="font-bold text-lg mb-2">Live Chat Management</h3>
                    <p class="text-gray-600 mb-6">Monitor and interact with active customer conversations</p>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="bg-gray-50 rounded-xl p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="font-bold">Active Sessions</h4>
                                    <button onclick="refreshActiveSessions()" class="text-blue-900 hover:text-blue-700 text-sm flex items-center space-x-1">
                                        <i data-feather="refresh-cw" class="w-4 h-4"></i>
                                        <span>Refresh</span>
                                    </button>
                                </div>
                                <div id="activeSessionsList" class="space-y-3">
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-feather="message-circle" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                        <p>No active chat sessions</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 rounded-xl p-6">
                            <h4 class="font-bold mb-4">Chat Information</h4>
                            <div class="space-y-4">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Active:</span>
                                    <span class="font-medium" id="totalActiveChats">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">In Booking Flow:</span>
                                    <span class="font-medium" id="bookingFlowChats">0</span>
                                </div>
                                <div class="pt-4 border-t">
                                    <p class="text-sm text-gray-600 mb-2">Quick Actions:</p>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <li>â€¢ Click "Chat" to join conversation</li>
                                        <li>â€¢ Use quick message buttons</li>
                                        <li>â€¢ Identify yourself as admin</li>
                                        <li>â€¢ Check session status first</li>
                                    </ul>
                                </div>
                                <div class="pt-4 border-t">
                                    <p class="text-sm text-gray-600 mb-2">Best Practices:</p>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <li>â€¢ Be prompt with responses</li>
                                        <li>â€¢ Use customer's name</li>
                                        <li>â€¢ Check booking progress</li>
                                        <li>â€¢ Follow up if needed</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Broadcast Section -->
                <div class="bg-white rounded-2xl shadow-lg p-6" id="broadcastSection" style="display:none;">
                    <h3 class="font-bold text-lg mb-2">Broadcast Messages</h3>
                    <p class="text-gray-600 mb-6">Send messages to different segments of your audience</p>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 mb-2 font-medium">Select Segment</label>
                                    <select id="segmentSelect" class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-900">
                                        <option value="all">All Bookings</option>
                                        <option value="book_tour">Confirmed Bookings</option>
                                        <option value="pending">Pending Bookings</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2 font-medium">Recipients</label>
                                    <div class="px-4 py-3 border rounded-xl bg-gray-50">
                                        <span class="font-medium text-blue-900" id="recipientCount">0</span> users will receive this message
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2 font-medium">Message Content</label>
                                <textarea id="broadcastMessage" class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-900" rows="6" placeholder="Type your broadcast message here..."></textarea>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-sm text-gray-500" id="charCount">0 characters</span>
                                    <span class="text-sm text-gray-500">WhatsApp formatting supported</span>
                                </div>
                            </div>

                            <!-- Sample Messages -->
                            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                                <h4 class="font-bold text-blue-800 mb-2">Sample Messages</h4>
                                <div class="space-y-2">
                                    <button onclick="loadSampleMessage('special_offer')" class="w-full text-left p-3 bg-white rounded-lg border border-blue-200 hover:bg-blue-50 transition-colors">
                                        <span class="font-medium text-blue-700">Special Offers</span>
                                        <p class="text-sm text-blue-600 mt-1">Promotions and discounts</p>
                                    </button>
                                    <button onclick="loadSampleMessage('weather_update')" class="w-full text-left p-3 bg-white rounded-lg border border-blue-200 hover:bg-blue-50 transition-colors">
                                        <span class="font-medium text-blue-700">Weather Updates</span>
                                        <p class="text-sm text-blue-600 mt-1">Cruise weather information</p>
                                    </button>
                                    <button onclick="loadSampleMessage('reminder')" class="w-full text-left p-3 bg-white rounded-lg border border-blue-200 hover:bg-blue-50 transition-colors">
                                        <span class="font-medium text-blue-700">Booking Reminders</span>
                                        <p class="text-sm text-blue-600 mt-1">Remind customers about their cruise</p>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex space-x-4">
                                <button id="previewBroadcast" class="flex-1 bg-gray-100 text-gray-700 py-3 px-6 rounded-xl font-medium hover:bg-gray-200 transition-all">
                                    Preview Message
                                </button>
                                <button id="sendBroadcastBtn" class="flex-1 sindbad-gradient text-white py-3 px-6 rounded-xl font-medium hover:opacity-90 transition-all shadow-lg">
                                    Send Broadcast Message
                                </button>
                            </div>

                            <!-- Broadcast Progress -->
                            <div id="broadcastProgress" class="hidden">
                                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-blue-700">Sending messages...</span>
                                        <span id="progressText" class="text-sm text-blue-600">0%</span>
                                    </div>
                                    <div class="w-full bg-blue-200 rounded-full h-2">
                                        <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                    <div id="progressDetails" class="text-xs text-blue-600 mt-2"></div>
                                </div>
                            </div>

                            <!-- Broadcast Results -->
                            <div id="broadcastResults" class="hidden">
                                <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                                    <h4 class="font-medium text-green-800 mb-2">Broadcast Completed</h4>
                                    <div id="resultsContent" class="text-sm text-green-700"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl p-6">
                            <h4 class="font-bold mb-4">Broadcast Information</h4>
                            <div class="space-y-4">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Selected Segment:</span>
                                    <span class="font-medium" id="segmentInfo">All Bookings</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Recipients:</span>
                                    <span class="font-medium" id="recipientCountInfo">0</span>
                                </div>
                                <div class="pt-4 border-t">
                                    <p class="text-sm text-gray-600 mb-2">Message Tips:</p>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <li>â€¢ Use *bold* for emphasis</li>
                                        <li>â€¢ Keep messages personal</li>
                                        <li>â€¢ Include clear call-to-action</li>
                                        <li>â€¢ Test with small group first</li>
                                        <li>â€¢ Avoid spammy content</li>
                                    </ul>
                                </div>
                                <div class="pt-4 border-t">
                                    <p class="text-sm text-gray-600 mb-2">Best Practices:</p>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <li>â€¢ Send during business hours</li>
                                        <li>â€¢ Personalize with names</li>
                                        <li>â€¢ Follow up after 24 hours</li>
                                        <li>â€¢ Track engagement rates</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Daily Reports Section -->
                <div class="bg-white rounded-2xl shadow-lg p-6" id="reportsSection" style="display:none;">
                    <h3 class="font-bold text-lg mb-2">Daily Reports</h3>
                    <p class="text-gray-600 mb-6">Generate CSV reports for specific dates</p>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
                                <h4 class="font-bold text-blue-800 mb-3">Generate Report</h4>
                                <p class="text-blue-700 mb-4">Create a detailed CSV report for any date showing all confirmed bookings and revenue.</p>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-gray-700 mb-2 font-medium">Select Report Date</label>
                                        <input type="date" id="reportDateInput" class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-900">
                                    </div>
                                    
                                    <button onclick="generateReport()" class="w-full sindbad-gradient text-white py-3 px-6 rounded-xl font-medium hover:opacity-90 transition-all shadow-lg flex items-center justify-center space-x-2">
                                        <i data-feather="file-text" class="w-5 h-5"></i>
                                        <span>Generate Daily Report CSV</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Quick Reports -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <h4 class="font-bold mb-4">Quick Reports</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <button onclick="generateQuickReport('today')" class="p-4 bg-white rounded-lg border hover:shadow-md transition-all text-center">
                                        <i data-feather="calendar" class="w-6 h-6 text-blue-600 mx-auto mb-2"></i>
                                        <p class="font-medium text-gray-800">Today</p>
                                        <p class="text-sm text-gray-600" id="todayBookings">0 bookings</p>
                                    </button>
                                    <button onclick="generateQuickReport('tomorrow')" class="p-4 bg-white rounded-lg border hover:shadow-md transition-all text-center">
                                        <i data-feather="sun" class="w-6 h-6 text-orange-600 mx-auto mb-2"></i>
                                        <p class="font-medium text-gray-800">Tomorrow</p>
                                        <p class="text-sm text-gray-600" id="tomorrowBookings">0 bookings</p>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl p-6">
                            <h4 class="font-bold mb-4">Report Information</h4>
                            <div class="space-y-4">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Today's Bookings:</span>
                                    <span class="font-medium" id="todayCount">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Tomorrow's Bookings:</span>
                                    <span class="font-medium" id="tomorrowCount">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">This Week's Revenue:</span>
                                    <span class="font-medium" id="weekRevenue">0 OMR</span>
                                </div>
                                <div class="pt-4 border-t">
                                    <p class="text-sm text-gray-600 mb-2">Report Includes:</p>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <li>â€¢ All confirmed bookings for selected date</li>
                                        <li>â€¢ Guest details and contact information</li>
                                        <li>â€¢ Cruise type and timing breakdown</li>
                                        <li>â€¢ Revenue summary and totals</li>
                                        <li>â€¢ Capacity utilization statistics</li>
                                    </ul>
                                </div>
                                <div class="pt-4 border-t">
                                    <p class="text-sm text-gray-600 mb-2">CSV Format Benefits:</p>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <li>â€¢ Opens in Excel, Google Sheets, Numbers</li>
                                        <li>â€¢ Easy to filter and sort data</li>
                                        <li>â€¢ Can be imported into other systems</li>
                                        <li>â€¢ Smaller file size for quick sharing</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            API_BASE_URL: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                ? 'http://localhost:5000' 
                : 'https://your-render-app.onrender.com',
            REFRESH_INTERVAL: 30000,
            ITEMS_PER_PAGE: 10,
            MAX_CAPACITY: 135,
            CHAT_POLL_INTERVAL: 3000
        };

        // State Management
        let appState = {
            bookings: [],
            filteredBookings: [],
            currentPage: 1,
            sortField: 'timestamp',
            sortDirection: 'desc',
            searchQuery: '',
            charts: {},
            broadcastInProgress: false,
            activeSessions: {},
            currentChatUser: null,
            chatPollInterval: null,
            currentChatHistory: [],
            lastMessageId: 0
        };

        // Initialize Application
        async function initApp() {
            showLoading();
            try {
                await loadAllData();
                setupEventListeners();
                startAutoRefresh();
                updateCurrentTime();
                hideLoading();
            } catch (error) {
                console.error('Initialization error:', error);
                hideLoading();
                showError('Initialization Failed', 'Could not load dashboard data');
            }
        }

        // Core Data Functions
        async function loadAllData() {
            try {
                const [bookingsResponse, sessionsResponse] = await Promise.all([
                    fetch(CONFIG.API_BASE_URL + '/api/bookings').catch(error => {
                        throw new Error(`Failed to fetch bookings: ${error.message}`);
                    }),
                    fetch(CONFIG.API_BASE_URL + '/api/active_sessions').catch(error => {
                        console.warn('Could not fetch active sessions:', error);
                        return { ok: true, json: () => Promise.resolve({ sessions: {} }) };
                    })
                ]);
                
                if (!bookingsResponse.ok) {
                    throw new Error(`HTTP error! status: ${bookingsResponse.status}`);
                }
                
                const bookings = await bookingsResponse.json();
                const sessions = await sessionsResponse.json();
                
                // Map the data to match our Google Sheets structure
                appState.bookings = Array.isArray(bookings) ? bookings.map(booking => ({
                    timestamp: booking.Timestamp || '',
                    bookingId: booking['Booking ID'] || '',
                    name: booking['Customer Name'] || '',
                    phone: booking['Phone Number'] || '',
                    whatsappId: booking['WhatsApp ID'] || '',
                    cruiseDate: booking['Cruise Date'] || '',
                    cruiseTime: booking['Cruise Time'] || '',
                    cruiseType: booking['Cruise Type'] || '',
                    adults: parseInt(booking['Adults Count']) || 0,
                    children: parseInt(booking['Children Count']) || 0,
                    infants: parseInt(booking['Infants Count']) || 0,
                    totalGuests: parseInt(booking['Total Guests']) || 0,
                    totalAmount: parseFloat(booking['Total Amount']) || 0,
                    paymentStatus: booking['Payment Status'] || '',
                    bookingStatus: booking['Booking Status'] || '',
                    language: booking['Language'] || 'English'
                })) : [];
                
                appState.filteredBookings = [...appState.bookings];
                appState.activeSessions = sessions.sessions || {};
                
                updateDashboard();
                updateBookingsTable();
                updateCharts();
                updateActiveSessions();
                updateReportsSection();
                updateBroadcastSection();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Connection Failed', `Cannot connect to server: ${error.message}`);
            }
        }

        // Enhanced Chat Functions
        async function openChat(phoneNumber, name = 'Customer') {
            try {
                appState.currentChatUser = { phoneNumber, name };
                appState.lastMessageId = 0;
                
                // Get user session info
                const sessionResponse = await fetch(`${CONFIG.API_BASE_URL}/api/user_session/${phoneNumber}`);
                const sessionInfo = await sessionResponse.json();
                
                document.getElementById('chatUserName').textContent = name || 'Customer';
                document.getElementById('chatUserPhone').textContent = phoneNumber;
                
                // Update session status
                const statusElement = document.getElementById('chatSessionStatus');
                if (sessionInfo.has_session) {
                    statusElement.textContent = `${sessionInfo.step.replace('awaiting_', '')} - ${sessionInfo.flow}`;
                    statusElement.className = 'text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full';
                } else {
                    statusElement.textContent = 'No active session';
                    statusElement.className = 'text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded-full';
                }
                
                // Load complete chat history
                await loadChatHistory(phoneNumber);
                
                document.getElementById('chatModal').classList.remove('hidden');
                document.getElementById('chatMessageInput').focus();
                feather.replace();
                
                // Start polling for new messages
                startChatPolling(phoneNumber);
                
            } catch (error) {
                console.error('Error opening chat:', error);
                showError('Chat Error', 'Failed to open chat session');
            }
        }

        async function loadChatHistory(phoneNumber) {
            try {
                // This would call your backend to get message history
                // For now, we'll simulate it
                appState.currentChatHistory = [
                    {
                        message: "Hello! I'd like to book a Sindbad cruise.",
                        sender: "user",
                        timestamp: new Date(Date.now() - 300000).toISOString(),
                        id: 1
                    },
                    {
                        message: "Welcome to Sindbad Ship Cruises! I'd be happy to help you book a cruise. Which date are you interested in?",
                        sender: "admin", 
                        timestamp: new Date(Date.now() - 240000).toISOString(),
                        id: 2
                    }
                ];
                
                renderChatMessages();
                
            } catch (error) {
                console.error('Error loading chat history:', error);
                appState.currentChatHistory = [];
                renderChatMessages();
            }
        }

        function renderChatMessages() {
            const chatMessages = document.getElementById('chatMessages');
            
            if (appState.currentChatHistory.length === 0) {
                chatMessages.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i data-feather="message-circle" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                `;
                return;
            }
            
            const sortedMessages = [...appState.currentChatHistory].sort((a, b) => 
                new Date(a.timestamp) - new Date(b.timestamp)
            );
            
            chatMessages.innerHTML = sortedMessages.map(msg => {
                const messageTime = new Date(msg.timestamp).toLocaleTimeString([], { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                return `
                <div class="chat-message ${msg.sender === 'admin' ? 'admin-message' : 'user-message'}">
                    <div class="text-sm">${escapeHtml(msg.message)}</div>
                    <div class="message-time text-right">
                        ${messageTime} â€¢ ${msg.sender === 'admin' ? 'You' : 'Customer'}
                    </div>
                </div>
            `}).join('');
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
            feather.replace();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function sendChatMessage() {
            const messageInput = document.getElementById('chatMessageInput');
            const message = messageInput.value.trim();
            
            if (!message || !appState.currentChatUser) {
                return;
            }
            
            try {
                messageInput.value = '';
                
                // Add message to chat UI immediately
                const tempMessage = {
                    message: message,
                    sender: 'admin',
                    timestamp: new Date().toISOString(),
                    id: Date.now()
                };
                appState.currentChatHistory.push(tempMessage);
                renderChatMessages();
                
                // In a real implementation, you'd send to your backend
                console.log('Sending message to', appState.currentChatUser.phoneNumber, ':', message);
                
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 500));
                
            } catch (error) {
                console.error('Error sending message:', error);
                showError('Send Failed', error.message);
            }
        }

        function startChatPolling(phoneNumber) {
            if (appState.chatPollingInterval) {
                clearInterval(appState.chatPollingInterval);
            }
            
            appState.chatPollingInterval = setInterval(async () => {
                if (appState.currentChatUser && appState.currentChatUser.phoneNumber === phoneNumber) {
                    // Poll for new messages
                    // This would call your backend in a real implementation
                }
            }, CONFIG.CHAT_POLL_INTERVAL);
        }

        function stopChatPolling() {
            if (appState.chatPollingInterval) {
                clearInterval(appState.chatPollingInterval);
                appState.chatPollingInterval = null;
            }
        }

        function insertQuickMessage(message) {
            document.getElementById('chatMessageInput').value = message;
            document.getElementById('chatMessageInput').focus();
        }

        function closeChat() {
            stopChatPolling();
            document.getElementById('chatModal').classList.add('hidden');
            appState.currentChatUser = null;
            appState.currentChatHistory = [];
            appState.lastMessageId = 0;
        }

        // Update active sessions display
        function updateActiveSessions() {
            const sessionsList = document.getElementById('activeSessionsList');
            const totalActive = document.getElementById('totalActiveChats');
            const bookingFlow = document.getElementById('bookingFlowChats');
            
            const activeSessions = Object.keys(appState.activeSessions).length;
            const bookingSessions = Object.values(appState.activeSessions).filter(s => s.flow === 'booking').length;
            
            totalActive.textContent = activeSessions;
            bookingFlow.textContent = bookingSessions;
            
            if (activeSessions === 0) {
                sessionsList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i data-feather="message-circle" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p>No active chat sessions</p>
                    </div>
                `;
            } else {
                sessionsList.innerHTML = Object.entries(appState.activeSessions).map(([phone, session]) => `
                    <div class="bg-white rounded-lg p-4 border hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="font-medium">${session.name || 'Unknown Customer'}</p>
                                <p class="text-sm text-gray-600">${phone}</p>
                            </div>
                            <span class="session-badge ${session.flow === 'booking' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                ${session.flow}
                            </span>
                        </div>
                        <div class="text-sm text-gray-600 mb-3">
                            <p>Step: <span class="font-medium">${session.step.replace('awaiting_', '')}</span></p>
                            ${session.tour_type !== 'Not selected' ? `<p>Cruise: <span class="font-medium">${session.tour_type}</span></p>` : ''}
                        </div>
                        <button onclick="openChat('${phone}', '${session.name || 'Customer'}')" 
                                class="w-full sindbad-gradient text-white py-2 rounded-lg hover:opacity-90 transition-all text-sm font-medium">
                            <i data-feather="message-circle" class="w-4 h-4 inline mr-1"></i>
                            Join Chat
                        </button>
                    </div>
                `).join('');
            }
            
            feather.replace();
        }

        async function refreshActiveSessions() {
            try {
                const response = await fetch(CONFIG.API_BASE_URL + '/api/active_sessions');
                const data = await response.json();
                
                if (response.ok) {
                    appState.activeSessions = data.sessions || {};
                    updateActiveSessions();
                    showSuccess('Refreshed', 'Active sessions updated');
                }
            } catch (error) {
                console.error('Error refreshing sessions:', error);
                showError('Refresh Failed', 'Could not update active sessions');
            }
        }

        // Broadcast Functions
        function updateBroadcastSection() {
            updateRecipientCount();
        }

        function updateRecipientCount() {
            const segment = document.getElementById('segmentSelect').value;
            let count = 0;
            
            switch(segment) {
                case 'all':
                    count = appState.bookings.length;
                    break;
                case 'book_tour':
                    count = appState.bookings.filter(b => b.bookingStatus === 'Confirmed').length;
                    break;
                case 'pending':
                    count = appState.bookings.filter(b => b.bookingStatus === 'Pending').length;
                    break;
            }
            
            document.getElementById('recipientCount').textContent = count.toLocaleString();
            document.getElementById('recipientCountInfo').textContent = count.toLocaleString();
            document.getElementById('segmentInfo').textContent = 
                document.getElementById('segmentSelect').options[document.getElementById('segmentSelect').selectedIndex].text;
        }

        function updateCharCount() {
            const message = document.getElementById('broadcastMessage').value;
            document.getElementById('charCount').textContent = `${message.length} characters`;
        }

        async function sendBroadcast() {
            if (appState.broadcastInProgress) {
                showError('Broadcast in Progress', 'Please wait for the current broadcast to complete.');
                return;
            }

            const segment = document.getElementById('segmentSelect').value;
            const message = document.getElementById('broadcastMessage').value.trim();
            
            if (!message) {
                showError('Broadcast Failed', 'Please enter a message to send.');
                return;
            }

            const recipientCount = document.getElementById('recipientCount').textContent;
            if (recipientCount === '0') {
                showError('No Recipients', 'No recipients found for the selected segment.');
                return;
            }

            appState.broadcastInProgress = true;
            showLoading();
            
            try {
                const response = await fetch(CONFIG.API_BASE_URL + '/api/broadcast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        segment: segment,
                        message: message
                    })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || result.message || 'Broadcast failed');
                }

                let successMessage = `âœ… Broadcast Completed!\n\nâ€¢ Sent: ${result.sent} messages\nâ€¢ Failed: ${result.failed} messages\nâ€¢ Total: ${result.total_recipients} recipients`;
                
                if (result.failed > 0) {
                    successMessage += `\n\nâš ï¸ Some failures may be due to:\nâ€¢ WhatsApp numbers not in allowed list\nâ€¢ Users outside 24-hour window\nâ€¢ Invalid phone numbers`;
                }
                
                showSuccess('Broadcast Results', successMessage);
                
                document.getElementById('broadcastMessage').value = '';
                updateCharCount();
                
            } catch (error) {
                console.error('Broadcast error:', error);
                showError('Broadcast Failed', error.message);
            } finally {
                appState.broadcastInProgress = false;
                hideLoading();
            }
        }

        function showPreview() {
            const message = document.getElementById('broadcastMessage').value.trim();
            if (!message) {
                showError('Preview Failed', 'Please enter a message to preview.');
                return;
            }
            
            document.getElementById('previewContent').textContent = message;
            document.getElementById('previewModal').classList.remove('hidden');
        }

        function hidePreview() {
            document.getElementById('previewModal').classList.add('hidden');
        }

        function confirmSend() {
            hidePreview();
            sendBroadcast();
        }

        // Sample Messages
        function loadSampleMessage(type) {
            const messages = {
                special_offer: `ðŸŒŠ *Sindbad Ship Cruises - Special Offer!* â˜€ï¸

Hello! Sindbad Ship Cruises has an exclusive promotion just for you:

ðŸŽ¯ *Summer Specials:*
â€¢ *15% OFF* all sunset cruises
â€¢ *Free refreshments* with any booking
â€¢ *Family package:* 4 people for the price of 3

ðŸ–ï¸ *Perfect Summer Activities:*
â€¢ Morning dolphin adventures ðŸ¬
â€¢ Afternoon snorkeling sessions ðŸ¤¿
â€¢ Sunset dhow cruises ðŸŒ…

ðŸ“… *Valid until end of August*
ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ *Perfect for family summer fun!*

Ready to make summer memories? Book now! ðŸ“ž +968 92734448`,

                weather_update: `ðŸŒ¤ï¸ *Sindbad Weather Update*

Good news! The weather looks perfect for your scheduled cruise:

â˜€ï¸ *Weather Conditions:*
â€¢ Clear skies
â€¢ Light breeze
â€¢ Perfect sea conditions

ðŸŽ’ *What to Bring:*
â€¢ Sunscreen
â€¢ Camera
â€¢ Light jacket for the breeze

We're looking forward to welcoming you aboard Sindbad! ðŸš¢`,

                reminder: `â° *Sindbad Reminder: Your Cruise Tomorrow*

Hello! This is a friendly reminder about your Sindbad Ship Cruises booking:

ðŸ“… *Date:* Tomorrow
ðŸ•’ *Reporting Time:* 1 hour before cruise
ðŸ“ *Location:* https://maps.app.goo.gl/woyVPSaZDSCG6UrWA

Please remember to bring your booking confirmation and arrive 1 hour early.

We can't wait to welcome you aboard! ðŸŒŠ`
            };
            
            document.getElementById('broadcastMessage').value = messages[type] || '';
            updateCharCount();
        }

        // Dashboard Updates
        function updateDashboard() {
            const bookings = appState.bookings;
            const total = bookings.length;
            const confirmed = bookings.filter(b => b.bookingStatus === 'Confirmed').length;
            const activeChats = Object.keys(appState.activeSessions).length;
            
            const today = new Date().toISOString().split('T')[0];
            const todayBookings = bookings.filter(booking => 
                booking.cruiseDate === today && booking.bookingStatus === 'Confirmed'
            );
            
            const totalRevenue = bookings
                .filter(b => b.bookingStatus === 'Confirmed')
                .reduce((sum, booking) => sum + booking.totalAmount, 0);
            
            const todayRevenue = todayBookings.reduce((sum, booking) => sum + booking.totalAmount, 0);

            document.getElementById("totalBookings").textContent = total.toLocaleString();
            document.getElementById("confirmedBookings").textContent = confirmed.toLocaleString();
            document.getElementById("totalRevenue").textContent = totalRevenue.toFixed(3) + ' OMR';
            document.getElementById("activeSessions").textContent = activeChats.toLocaleString();
            
            const confirmedPercentage = total > 0 ? Math.round((confirmed / total) * 100) : 0;
            
            document.getElementById("confirmedPercentage").textContent = `${confirmedPercentage}%`;
            document.getElementById("bookingsGrowth").textContent = `+${todayBookings.length} today`;
            document.getElementById("revenueGrowth").textContent = `+${todayRevenue.toFixed(3)} today`;
            document.getElementById("sessionsGrowth").textContent = `+${activeChats} active`;
            
            updateRecentBookings();
        }

        function updateRecentBookings() {
            const recentBookingsContainer = document.getElementById('recentBookings');
            const recentBookings = appState.bookings
                .filter(b => b.bookingStatus === 'Confirmed')
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);
            
            if (recentBookings.length === 0) {
                recentBookingsContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i data-feather="users" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p>No recent bookings</p>
                    </div>
                `;
                return;
            }
            
            recentBookingsContainer.innerHTML = recentBookings.map(booking => `
                <div class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 transition-colors">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                            <i data-feather="user" class="w-5 h-5 text-blue-900"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">${booking.name}</p>
                            <p class="text-sm text-gray-500">${booking.phone} â€¢ ${booking.cruiseType}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="inline-block px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">
                            ${booking.totalGuests} guests
                        </span>
                        <p class="text-xs text-gray-500 mt-1">${booking.cruiseDate} â€¢ ${booking.totalAmount.toFixed(3)} OMR</p>
                    </div>
                </div>
            `).join('');
            
            feather.replace();
        }

        // Bookings Table
        function updateBookingsTable() {
            const tableBody = document.getElementById('bookingsTableBody');
            const paginationInfo = document.getElementById('bookingsPaginationInfo');
            const paginationContainer = document.getElementById('bookingsPagination');
            
            if (appState.filteredBookings.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="px-6 py-4 text-center text-gray-500">
                            No bookings found matching your search criteria.
                        </td>
                    </tr>
                `;
                paginationInfo.textContent = 'Showing 0 of 0 bookings';
                paginationContainer.innerHTML = '';
                return;
            }
            
            const totalPages = Math.ceil(appState.filteredBookings.length / CONFIG.ITEMS_PER_PAGE);
            const startIndex = (appState.currentPage - 1) * CONFIG.ITEMS_PER_PAGE;
            const endIndex = startIndex + CONFIG.ITEMS_PER_PAGE;
            const currentBookings = appState.filteredBookings.slice(startIndex, endIndex);
            
            tableBody.innerHTML = currentBookings.map(booking => {
                const statusClass = booking.bookingStatus === 'Confirmed' ? 
                    'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                
                return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${formatDate(booking.timestamp)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${booking.bookingId}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${booking.name}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${booking.phone}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${booking.cruiseType}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${booking.cruiseDate}<br>
                        <span class="text-xs text-gray-400">${booking.cruiseTime}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${booking.totalGuests} total<br>
                        <span class="text-xs text-gray-400">${booking.adults}A ${booking.children}C ${booking.infants}I</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${booking.totalAmount.toFixed(3)} OMR
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">
                            ${booking.bookingStatus}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="openChat('${booking.whatsappId}', '${booking.name.replace(/'/g, "\\'")}')" 
                                class="flex items-center space-x-1 sindbad-gradient text-white px-3 py-1 rounded-lg hover:opacity-90 transition-all text-xs font-medium">
                            <i data-feather="message-circle" class="w-3 h-3"></i>
                            <span>Chat</span>
                        </button>
                    </td>
                </tr>
            `}).join('');
            
            paginationInfo.textContent = `Showing ${startIndex + 1}-${Math.min(endIndex, appState.filteredBookings.length)} of ${appState.filteredBookings.length} bookings`;
            updatePaginationButtons(totalPages, paginationContainer);
            feather.replace();
        }

        // Capacity Monitoring
        async function updateCapacityDisplay() {
            const date = document.getElementById('capacityDate').value || new Date().toISOString().split('T')[0];
            const capacityCards = document.getElementById('capacityCards');
            
            const cruiseTypes = [
                { key: 'morning', name: 'Morning Cruise', time: '9:00 AM - 10:30 AM' },
                { key: 'afternoon', name: 'Afternoon Cruise', time: '1:30 PM - 3:00 PM' },
                { key: 'sunset', name: 'Sunset Cruise', time: '5:00 PM - 6:30 PM' },
                { key: 'evening', name: 'Evening Cruise', time: '7:30 PM - 9:00 PM' }
            ];

            let cardsHTML = '';
            
            for (const cruise of cruiseTypes) {
                try {
                    const response = await fetch(`${CONFIG.API_BASE_URL}/api/capacity/${date}/${cruise.name}`);
                    const capacityData = await response.json();
                    
                    const currentCapacity = capacityData.current_capacity || 0;
                    const availableSeats = capacityData.available_seats || 0;
                    const utilization = Math.round((currentCapacity / CONFIG.MAX_CAPACITY) * 100);
                    
                    let cardClass = 'stats-card rounded-2xl shadow-lg p-6 card-hover';
                    if (utilization >= 90) {
                        cardClass = 'capacity-full rounded-2xl shadow-lg p-6 card-hover';
                    } else if (utilization >= 70) {
                        cardClass = 'capacity-warning rounded-2xl shadow-lg p-6 card-hover';
                    }
                    
                    cardsHTML += `
                        <div class="${cardClass}">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">${cruise.name}</p>
                                    <p class="text-xs text-gray-400">${cruise.time}</p>
                                </div>
                                <div class="p-2 rounded-lg bg-blue-100">
                                    <i data-feather="users" class="w-4 h-4 text-blue-900"></i>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Booked:</span>
                                    <span class="font-medium">${currentCapacity} / ${CONFIG.MAX_CAPACITY}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Available:</span>
                                    <span class="font-medium ${availableSeats < 20 ? 'text-red-600' : 'text-green-600'}">${availableSeats} seats</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                         style="width: ${utilization}%"></div>
                                </div>
                                <div class="text-xs text-gray-500 text-center">${utilization}% utilized</div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error(`Error fetching capacity for ${cruise.name}:`, error);
                }
            }
            
            capacityCards.innerHTML = cardsHTML;
            feather.replace();
        }

        // Reports Section
        function updateReportsSection() {
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
            
            const todayBookings = appState.bookings.filter(b => 
                b.cruiseDate === today && b.bookingStatus === 'Confirmed'
            );
            const tomorrowBookings = appState.bookings.filter(b => 
                b.cruiseDate === tomorrow && b.bookingStatus === 'Confirmed'
            );
            
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekRevenue = appState.bookings
                .filter(b => {
                    const bookingDate = new Date(b.cruiseDate);
                    return bookingDate >= weekStart && b.bookingStatus === 'Confirmed';
                })
                .reduce((sum, b) => sum + b.totalAmount, 0);
            
            document.getElementById('todayCount').textContent = todayBookings.length;
            document.getElementById('tomorrowCount').textContent = tomorrowBookings.length;
            document.getElementById('weekRevenue').textContent = weekRevenue.toFixed(3) + ' OMR';
            document.getElementById('todayBookings').textContent = `${todayBookings.length} bookings`;
            document.getElementById('tomorrowBookings').textContent = `${tomorrowBookings.length} bookings`;
            
            // Set default date for report generation to today
            document.getElementById('reportDateInput').value = today;
        }

        async function generateReport() {
            const date = document.getElementById('reportDateInput').value;
            if (!date) {
                showError('Date Required', 'Please select a date for the report');
                return;
            }
            
            try {
                showLoading();
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/report/${date}`);
                
                if (!response.ok) {
                    throw new Error('Failed to generate report');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `Sindbad_Report_${date}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showSuccess('Report Generated', `CSV report for ${date} downloaded successfully`);
            } catch (error) {
                console.error('Error generating report:', error);
                showError('Report Failed', 'Could not generate CSV report');
            } finally {
                hideLoading();
            }
        }

        function generateQuickReport(type) {
            let date;
            if (type === 'today') {
                date = new Date().toISOString().split('T')[0];
            } else if (type === 'tomorrow') {
                date = new Date(Date.now() + 86400000).toISOString().split('T')[0];
            }
            
            document.getElementById('reportDateInput').value = date;
            generateReport();
        }

        // Chart Functions
        function updateCharts() {
            updateCruiseTypeChart();
            updateStatusChart();
        }

        function updateCruiseTypeChart() {
            const ctx = document.getElementById('cruiseChart').getContext('2d');
            const cruiseTypes = {};
            
            appState.bookings.forEach(booking => {
                if (booking.bookingStatus === 'Confirmed') {
                    const type = booking.cruiseType || 'Not specified';
                    cruiseTypes[type] = (cruiseTypes[type] || 0) + 1;
                }
            });

            if (window.cruiseChartInstance) {
                window.cruiseChartInstance.destroy();
            }

            window.cruiseChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cruiseTypes),
                    datasets: [{
                        data: Object.values(cruiseTypes),
                        backgroundColor: [
                            '#1e3a8a', '#0ea5e9', '#38bdf8', '#7dd3fc',
                            '#0d9488', '#10b981', '#34d399', '#6ee7b7'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        function updateStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            const statusCounts = {
                'Confirmed': 0,
                'Pending': 0,
                'Cancelled': 0
            };
            
            appState.bookings.forEach(booking => {
                const status = booking.bookingStatus || 'Pending';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            if (window.statusChartInstance) {
                window.statusChartInstance.destroy();
            }

            window.statusChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return dateString;
            }
        }

        function showLoading() {
            document.getElementById('loadingScreen').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function showError(title, message) {
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
            
            setTimeout(hideError, 5000);
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showSuccess(title, message) {
            document.getElementById('successTitle').textContent = title;
            document.getElementById('successText').textContent = message;
            document.getElementById('successMessage').classList.remove('hidden');
            
            setTimeout(() => {
                document.getElementById('successMessage').classList.add('hidden');
            }, 3000);
        }

        function updateCurrentTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleTimeString();
        }

        function startAutoRefresh() {
            setInterval(() => {
                loadAllData();
                updateCurrentTime();
            }, CONFIG.REFRESH_INTERVAL);
        }

        // Navigation
        function showSection(section) {
            document.querySelectorAll('nav a').forEach(nav => {
                nav.classList.remove('nav-active');
                nav.classList.remove('bg-white', 'bg-opacity-20', 'shadow-lg');
            });

            const activeLink = document.getElementById(`${section}Link`);
            if (activeLink) {
                activeLink.classList.add('nav-active');
                activeLink.classList.add('bg-white', 'bg-opacity-20', 'shadow-lg');
            }
            
            ['dashboard', 'leads', 'capacity', 'chat', 'broadcast', 'reports'].forEach(sec => {
                const sectionEl = document.getElementById(`${sec}Section`);
                if (sectionEl) {
                    sectionEl.style.display = 'none';
                }
            });
            
            const targetSection = document.getElementById(`${section}Section`);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            const titles = {
                dashboard: 'Dashboard Overview',
                leads: 'Bookings Management',
                capacity: 'Capacity Monitor',
                chat: 'Live Chat Management',
                broadcast: 'Broadcast Messages',
                reports: 'Daily Reports'
            };
            
            const subtitles = {
                dashboard: 'Sindbad Ship Cruises - Luxury Sea Experiences',
                leads: 'Manage and track all Sindbad cruise bookings',
                capacity: 'Real-time cruise capacity tracking',
                chat: 'Monitor and interact with active customer conversations',
                broadcast: 'Send targeted messages to your audience',
                reports: 'Generate CSV reports for specific dates'
            };
            
            document.getElementById('pageTitle').textContent = titles[section] || 'Dashboard';
            document.getElementById('pageSubtitle').textContent = subtitles[section] || 'Sindbad Ship Cruises';

            if (section === 'capacity') {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('capacityDate').value = today;
                updateCapacityDisplay();
            } else if (section === 'reports') {
                updateReportsSection();
            } else if (section === 'broadcast') {
                updateBroadcastSection();
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // Navigation
            document.getElementById('dashboardLink').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('dashboard');
            });
            
            document.getElementById('leadsLink').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('leads');
            });
            
            document.getElementById('capacityLink').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('capacity');
            });
            
            document.getElementById('chatLink').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('chat');
            });
            
            document.getElementById('broadcastLink').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('broadcast');
            });
            
            document.getElementById('reportsLink').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('reports');
            });
            
            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', loadAllData);
            
            // Search functionality
            const searchInput = document.getElementById('searchBookings');
            if (searchInput) {
                searchInput.addEventListener('input', searchBookings);
            }
            
            // PDF Export
            document.getElementById('exportPDF').addEventListener('click', exportToCSV);
            
            // Broadcast functionality
            document.getElementById('segmentSelect').addEventListener('change', updateRecipientCount);
            document.getElementById('broadcastMessage').addEventListener('input', updateCharCount);
            document.getElementById('sendBroadcastBtn').addEventListener('click', sendBroadcast);
            
            // Chat functionality
            document.getElementById('closeChat').addEventListener('click', closeChat);
            document.getElementById('sendChatMessage').addEventListener('click', sendChatMessage);
            const chatInput = document.getElementById('chatMessageInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
        }

        function searchBookings() {
            const query = document.getElementById('searchBookings').value.toLowerCase();
            appState.searchQuery = query;
            appState.currentPage = 1;
            
            if (!query) {
                appState.filteredBookings = [...appState.bookings];
            } else {
                appState.filteredBookings = appState.bookings.filter(booking => 
                    (booking.name && booking.name.toLowerCase().includes(query)) ||
                    (booking.phone && booking.phone.toLowerCase().includes(query)) ||
                    (booking.bookingId && booking.bookingId.toLowerCase().includes(query)) ||
                    (booking.cruiseType && booking.cruiseType.toLowerCase().includes(query))
                );
            }
            
            updateBookingsTable();
        }

        function updatePaginationButtons(totalPages, container) {
            let buttons = '';
            
            buttons += `
                <button onclick="changePage(${appState.currentPage - 1})" 
                        ${appState.currentPage === 1 ? 'disabled' : ''}
                        class="px-3 py-1 rounded-lg border ${appState.currentPage === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-50'}">
                    Previous
                </button>
            `;
            
            for (let i = 1; i <= totalPages; i++) {
                buttons += `
                    <button onclick="changePage(${i})" 
                            class="px-3 py-1 rounded-lg border ${appState.currentPage === i ? 'sindbad-gradient text-white' : 'bg-white text-gray-700 hover:bg-gray-50'}">
                        ${i}
                    </button>
                `;
            }
            
            buttons += `
                <button onclick="changePage(${appState.currentPage + 1})" 
                        ${appState.currentPage === totalPages ? 'disabled' : ''}
                        class="px-3 py-1 rounded-lg border ${appState.currentPage === totalPages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-50'}">
                    Next
                </button>
            `;
            
            container.innerHTML = buttons;
        }

        function changePage(page) {
            const totalPages = Math.ceil(appState.filteredBookings.length / CONFIG.ITEMS_PER_PAGE);
            if (page >= 1 && page <= totalPages) {
                appState.currentPage = page;
                updateBookingsTable();
            }
        }

        function exportToCSV() {
            // Create CSV content
            let csvContent = "Sindbad Ship Cruises - Bookings Report\n";
            csvContent += `Generated on: ${new Date().toLocaleDateString()}\n\n`;
            
            // Summary
            const totalBookings = appState.bookings.length;
            const confirmedBookings = appState.bookings.filter(b => b.bookingStatus === 'Confirmed').length;
            const totalRevenue = appState.bookings
                .filter(b => b.bookingStatus === 'Confirmed')
                .reduce((sum, b) => sum + b.totalAmount, 0);
            
            csvContent += "Summary\n";
            csvContent += `Total Bookings,${totalBookings}\n`;
            csvContent += `Confirmed Bookings,${confirmedBookings}\n`;
            csvContent += `Total Revenue,${totalRevenue.toFixed(3)} OMR\n\n`;
            
            // Headers
            csvContent += "Booking ID,Name,Phone,Cruise Type,Date,Time,Guests,Amount,Status\n";
            
            // Data
            appState.bookings.forEach(booking => {
                csvContent += `"${booking.bookingId}","${booking.name}","${booking.phone}","${booking.cruiseType}","${booking.cruiseDate}","${booking.cruiseTime}",${booking.totalGuests},${booking.totalAmount.toFixed(3)} OMR,${booking.bookingStatus}\n`;
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `Sindbad-Bookings-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            initApp();
        });
    </script>
</body>
</html>